require 'rubygems'
require 'ffi'
require 'sinatra'
require 'benchmark'

module Imageflow
  module Riapi
    class Server < Sinatra::Base

      def process_bytes_and_hash(bytes:, hash:)
        job = nil
        cpu_time = Benchmark.realtime do
          job = ClassicJob.new image_source: ImageSource.from_binary(binary_string: bytes),
                               instructions: Instructions.new(hash)

          job.acquire_bytes!
        end

        response.headers['X-CPU-TIME'] = "%.4f" % (cpu_time * 1000.0)
        content_type job.result_content_type

        job.result_bytes
      end


      get '/tinypng' do

        bytes = "\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52\x00\x00\x00\x01\x00\x00\x00\x01\x08\x06\x00\x00\x00\x1F\x15\xC4\x89\x00\x00\x00\x0A\x49\x44\x41\x54\x78\x9C\x63\x00\x01\x00\x00\x05\x00\x01\x0D\x0A\x2D\xB4\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82".b

        process_bytes_and_hash(bytes: bytes, hash: request.env['rack.request.query_hash'])

      end

      get '/jpeg32' do
        bytes = "\xFF\xD8\xFF\xE0\x00\x10\x4A\x46\x49\x46\x00\x01\x01\x01\x00\x48\x00\x48\x00\x00\xFF\xDB\x00\x43\x00\x50\x37\x3C\x46\x3C\x32\x50\x46\x41\x46\x5A\x55\x50\x5F\x78\xC8\x82\x78\x6E\x6E\x78\xF5\xAF\xB9\x91\xC8\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF"\
        "\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xDB\x00\x43\x01\x55\x5A\x5A\x78\x69\x78\xEB\x82\x82\xEB\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF"\
        "\xC0\x00\x11\x08\x00\x20\x00\x20\x03\x01\x22\x00\x02\x11\x01\x03\x11\x01\xFF\xC4\x00\x15\x00\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\xFF\xC4\x00\x14\x10\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xFF\xC4\x00\x14\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"\
        "\x00\x00\x00\x00\x00\x00\xFF\xC4\x00\x14\x11\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xFF\xDA\x00\x0C\x03\x01\x00\x02\x11\x03\x11\x00\x3F\x00\x88\x00\x00\x00\x00\x00\x07\xFF\xD9".b

        process_bytes_and_hash(bytes: bytes, hash: request.env['rack.request.query_hash'])

      end



      get '/ri/:path' do |path|
        @@cache ||= {}
        #url = "http://z.zr.io/ri/#{path}?width=1600&quality=80"
        url = "http://s3.amazonaws.com/resizer-images/#{path}"
        @@cache[url] ||= Net::HTTP.get(URI(url))

        process_bytes_and_hash(bytes: @@cache[url], hash: request.env['rack.request.query_hash'])
      end
    end
  end
end

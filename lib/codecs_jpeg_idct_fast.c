#include <stdio.h>
#include "imageflow_private.h"
#include "lcms2.h"
#include "codecs.h"

#define JPEG_INTERNALS
#include "libjpeg-turbo_private/jpeglib.h"
#include "libjpeg-turbo_private/jinclude.h"
#include "libjpeg-turbo_private/jconfigint.h" /* Private declarations for DCT subsystem */

//#include "libjpeg-turbo_private/jmorecfg.h" /* Private declarations for DCT subsystem */
#include "libjpeg-turbo_private/jdct.h" /* Private declarations for DCT subsystem */

#include "fastapprox.h"

void jpeg_idct_downscale_wrap_islow_fast(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                    JSAMPARRAY output_buf, JDIMENSION output_col);

float jpeg_scale_to_7_x_7_weights[7][8] = {
    { 0.9039465785026550293, 0.0960534214973449707, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { -0.0159397963434457779, 0.8046712279319763184, 0.2112685889005661011, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, -0.0307929217815399170, 0.6724552512168884277, 0.3583376407623291016, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, -0.0303521882742643356, 0.5303522348403930664, 0.5303522348403930664, -0.0303521882742643356, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.3583376407623291016, 0.6724552512168884277, -0.0307929217815399170, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.2112685889005661011, 0.8046712279319763184, -0.0159397963434457779 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0960534214973449707, 0.9039465785026550293 },
};
float jpeg_scale_to_6_x_6_weights[6][8] = {
    { 0.7491279840469360352, 0.2508720457553863525, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { -0.0224444177001714706, 0.5224443674087524414, 0.5224443674087524414, -0.0224444177001714706, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.2396661937236785889, 0.7156662940979003906, 0.0446674935519695282, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0446674935519695282, 0.7156662940979003906, 0.2396661937236785889, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, -0.0224444177001714706, 0.5224443674087524414, 0.5224443674087524414, -0.0224444177001714706 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.2508720457553863525, 0.7491279840469360352 },
};
float jpeg_scale_to_5_x_5_weights[5][8] = {
    { 0.6118828058242797852, 0.4002380371093750000, -0.0121208345517516136, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { -0.0219573117792606354, 0.2555175423622131348, 0.6176261901855468750, 0.1488135904073715210, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0161152519285678864, 0.4838847517967224121, 0.4838847517967224121, 0.0161152519285678864, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.1488135904073715210, 0.6176261901855468750, 0.2555175423622131348, -0.0219573117792606354 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, -0.0121208345517516136, 0.4002380371093750000, 0.6118828058242797852 },
};
float jpeg_scale_to_4_x_4_weights[4][8] = {
    { 0.4553350806236267090, 0.4553350806236267090, 0.0893298164010047913, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0820043832063674927, 0.4179956316947937012, 0.4179956316947937012, 0.0820043832063674927, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0820043832063674927, 0.4179956316947937012, 0.4179956316947937012, 0.0820043832063674927, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0893298164010047913, 0.4553350806236267090, 0.4553350806236267090 },
};
float jpeg_scale_to_3_x_3_weights[3][8] = {
    { 0.3126847147941589355, 0.4027547538280487061, 0.2417637705802917480, 0.0427967458963394165, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0095250364392995834, 0.1524054706096649170, 0.3380694985389709473, 0.3380694985389709473, 0.1524054706096649170, 0.0095250364392995834, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0427967458963394165, 0.2417637705802917480, 0.4027547538280487061, 0.3126847147941589355 },
};
float jpeg_scale_to_2_x_2_weights[2][8] = {
    { 0.1866819113492965698, 0.2613925635814666748, 0.2613925635814666748, 0.1866819113492965698, 0.0875365510582923889, 0.0163145177066326141, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0163145177066326141, 0.0875365510582923889, 0.1866819113492965698, 0.2613925635814666748, 0.2613925635814666748, 0.1866819113492965698 },
};
float jpeg_scale_to_1_x_1_weights[1][8] = {
    { 0.0911070853471755981, 0.1178331747651100159, 0.1392842531204223633, 0.1517754793167114258, 0.1517754793167114258, 0.1392842531204223633, 0.1178331747651100159, 0.0911070853471755981 },
};

FLOW_EXPORT float * weights_by_target[7] = {
    &jpeg_scale_to_1_x_1_weights[0][0],
    &jpeg_scale_to_2_x_2_weights[0][0],
    &jpeg_scale_to_3_x_3_weights[0][0],
    &jpeg_scale_to_4_x_4_weights[0][0],
    &jpeg_scale_to_5_x_5_weights[0][0],
    &jpeg_scale_to_6_x_6_weights[0][0],
    &jpeg_scale_to_7_x_7_weights[0][0]

};

const float lut_srgb_to_linear[256] = {
    0.0000000000000000000, 0.0003035269910469651, 0.0006070539820939302, 0.0009105810313485563, 0.0012141079641878605, 0.0015176349552348256, 0.0018211620626971126, 0.0021246890537440777,
    0.0024282159283757210, 0.0027317430358380079, 0.0030352699104696512, 0.0033465356100350618, 0.0036765069235116243, 0.0040247170254588127, 0.0043914420530200005, 0.0047769532538950443,
    0.0051815169863402843, 0.0056053916923701763, 0.0060488325543701649, 0.0065120910294353962, 0.0069954101927578449, 0.0074990317225456238, 0.0080231921747326851, 0.0085681248456239700,
    0.0091340569779276848, 0.0097212176769971848, 0.0103298230096697807, 0.0109600936993956566, 0.0116122448816895485, 0.0122864870354533195, 0.0129830306395888329, 0.0137020805850625038,
    0.0144438436254858971, 0.0152085144072771072, 0.0159962922334671021, 0.0168073754757642746, 0.0176419522613286972, 0.0185002181679010391, 0.0193823613226413727, 0.0202885624021291733,
    0.0212190095335245132, 0.0221738833934068680, 0.0231533646583557129, 0.0241576302796602249, 0.0251868572086095810, 0.0262412223964929581, 0.0273208916187286377, 0.0284260381013154984,
    0.0295568425208330154, 0.0307134501636028290, 0.0318960398435592651, 0.0331047736108303070, 0.0343398116528987885, 0.0356013253331184387, 0.0368894524872303009, 0.0382043756544589996,
    0.0395462475717067719, 0.0409152098000049591, 0.0423114225268363953, 0.0437350422143936157, 0.0451862141489982605, 0.0466650947928428650, 0.0481718331575393677, 0.0497065745294094086,
    0.0512694679200649261, 0.0528606548905372620, 0.0544802807271480560, 0.0561284944415092468, 0.0578054338693618774, 0.0595112405717372894, 0.0612460710108280182, 0.0630100294947624207,
    0.0648032799363136292, 0.0666259527206420898, 0.0684781819581985474, 0.0703601092100143433, 0.0722718611359596252, 0.0742135792970657349, 0.0761853903532028198, 0.0781874284148216248,
    0.0802198275923728943, 0.0822827145457267761, 0.0843762159347534180, 0.0865004658699035645, 0.0886556059122085571, 0.0908417329192161560, 0.0930589810013771057, 0.0953074842691421509,
    0.0975873619318008423, 0.0998987406492233276, 0.1022417470812797546, 0.1046164929866790771, 0.1070231124758720398, 0.1094617173075675964, 0.1119324341416358948, 0.1144353821873664856,
    0.1169706955552101135, 0.1195384487509727478, 0.1221388131380081177, 0.1247718632221221924, 0.1274377256631851196, 0.1301365196704864502, 0.1328683644533157349, 0.1356333643198013306,
    0.1384316533803939819, 0.1412633210420608521, 0.1441285014152526855, 0.1470272988080978394, 0.1499598175287246704, 0.1529261767864227295, 0.1559264957904815674, 0.1589608639478683472,
    0.1620294302701950073, 0.1651322394609451294, 0.1682694554328918457, 0.1714411526918411255, 0.1746474504470825195, 0.1778884679079055786, 0.1811642944812774658, 0.1844750344753265381,
    0.1878208070993423462, 0.1912017166614532471, 0.1946178674697875977, 0.1980693489313125610, 0.2015562951564788818, 0.2050787657499313354, 0.2086368948221206665, 0.2122307866811752319,
    0.2158605307340621948, 0.2195262312889099121, 0.2232279777526855469, 0.2269658893346786499, 0.2307400703430175781, 0.2345506548881530762, 0.2383976578712463379, 0.2422811985015869141,
    0.2462013959884643555, 0.2501583695411682129, 0.2541521787643432617, 0.2581829130649566650, 0.2622507214546203613, 0.2663556635379791260, 0.2704978585243225098, 0.2746773660182952881,
    0.2788943350315093994, 0.2831487953662872314, 0.2874408960342407227, 0.2917706966400146484, 0.2961383163928985596, 0.3005438446998596191, 0.3049873709678649902, 0.3094689548015594482,
    0.3139887452125549316, 0.3185468316078186035, 0.3231432437896728516, 0.3277781307697296143, 0.3324515819549560547, 0.3371636569499969482, 0.3419144451618194580, 0.3467040956020355225,
    0.3515326976776123047, 0.3564002513885498047, 0.3613068759441375732, 0.3662526905536651611, 0.3712377846240997314, 0.3762622177600860596, 0.3813261091709136963, 0.3864295184612274170,
    0.3915725648403167725, 0.3967553079128265381, 0.4019778668880462646, 0.4072403013706207275, 0.4125427007675170898, 0.4178851544857025146, 0.4232677519321441650, 0.4286905527114868164,
    0.4341537058353424072, 0.4396572411060333252, 0.4452012479305267334, 0.4507858455181121826, 0.4564110636711120605, 0.4620770514011383057, 0.4677838385105133057, 0.4735315442085266113,
    0.4793202280998229980, 0.4851499795913696289, 0.4910208880901336670, 0.4969330430030822754, 0.5028865933418273926, 0.5088814496994018555, 0.5149177908897399902, 0.5209956765174865723,
    0.5271153450012207031, 0.5332766175270080566, 0.5394796729087829590, 0.5457246899604797363, 0.5520116090774536133, 0.5583406090736389160, 0.5647116899490356445, 0.5711250305175781250,
    0.5775806307792663574, 0.5840786099433898926, 0.5906190276145935059, 0.5972020030021667480, 0.6038275361061096191, 0.6104957461357116699, 0.6172067523002624512, 0.6239605545997619629,
    0.6307573318481445312, 0.6375970244407653809, 0.6444798707962036133, 0.6514058113098144531, 0.6583749651908874512, 0.6653874516487121582, 0.6724433302879333496, 0.6795426011085510254,
    0.6866854429244995117, 0.6938720345497131348, 0.7011021375656127930, 0.7083760499954223633, 0.7156937718391418457, 0.7230553627014160156, 0.7304610013961791992, 0.7379106879234313965,
    0.7454044818878173828, 0.7529424428939819336, 0.7605247497558593750, 0.7681514024734497070, 0.7758224606513977051, 0.7835380434989929199, 0.7912981510162353516, 0.7991029620170593262,
    0.8069524765014648438, 0.8148468136787414551, 0.8227859735488891602, 0.8307700753211975098, 0.8387992382049560547, 0.8468734622001647949, 0.8549928069114685059, 0.8631573915481567383,
    0.8713673353195190430, 0.8796225786209106445, 0.8879231810569763184, 0.8962695598602294922, 0.9046613574028015137, 0.9130989909172058105, 0.9215820431709289551, 0.9301111698150634766,
    0.9386858940124511719, 0.9473068714141845703, 0.9559735059738159180, 0.9646865725517272949, 0.9734454751014709473, 0.9822508692741394043, 0.9911022186279296875, 1.0000000000000000000,
};
static inline uint8_t fast_linear_to_srgb(float x)
{
    return uchar_clamp_ff(linear_to_srgb(x));

//    // Gamma correction
//    // http://www.4p8.com/eric.brasseur/gamma.html#formulas
//    if (x < 0.0f)
//        return 0;
//    if (x > 1.0f)
//        return 255.0f;
//    float r = 255.0f * fasterpow(x, 1.0f / 2.2f);
//    // return 255.0f * (float)pow(clr, 1.0f / 2.2f);
//    // printf("Linear %f to srgb %f\n", x, r);
//    return r;
}


void jpeg_idct_downscale_wrap_islow_fast(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                    JSAMPARRAY output_buf, JDIMENSION output_col)
{

    JSAMPLE intermediate[DCTSIZE2];
    JSAMPROW rows[DCTSIZE];
    JSAMPROW outptr;
    // JSAMPLE * range_limit = cinfo->sample_range_limit;
    int i, ctr, ctr_x;

    for (i = 0; i < DCTSIZE; i++)
        rows[i] = &intermediate[i * DCTSIZE];

    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);

#if JPEG_LIB_VERSION >= 70
    int scaled = compptr->DCT_h_scaled_size;
#else
    int scaled = compptr->DCT_scaled_size;
#endif

    //Linearize
    float linearized[DCTSIZE2];
    for (i = 0; i < DCTSIZE2; i++)
        linearized[i] = lut_srgb_to_linear[intermediate[i]];


    //Scale and transpose
    float scaled_h[DCTSIZE2];
    for (int row = 0; row < DCTSIZE; row++) {
        for (int to = 0; to < scaled; to++) {
            const float * weights = weights_by_target[scaled] + DCTSIZE * to;
            float sum = 0;
            for (int from = 0; from < DCTSIZE; from++) {
                sum += weights[from] * linearized[row * DCTSIZE + from];
            }
            scaled_h[to * DCTSIZE + row] = sum;
        }
    }
    //Scale and transpose again
    float scaled_final[DCTSIZE2];
    for (int row = 0; row < scaled; row++) {
        for (int to = 0; to < scaled; to++) {
            const float * weights = weights_by_target[scaled] + DCTSIZE * to;
            float sum = 0;
            for (int from = 0; from < DCTSIZE; from++) {
                sum += weights[from] * scaled_h[row * DCTSIZE + from];
            }
            scaled_final[to * scaled + row] = sum;
        }
    }

    // int input_pixels_window =  8 / scaled;
    int target_size = scaled;
    for (ctr = 0; ctr < target_size; ctr++) {
        outptr = output_buf[ctr] + output_col;
        for (ctr_x = 0; ctr_x < target_size; ctr_x++) {
            outptr[ctr_x] = fast_linear_to_srgb(scaled_final[ctr_x + ctr * target_size]);
        }
    }
}

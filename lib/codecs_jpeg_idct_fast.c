

// Usage example
// Suggested configuration names: scale_luma_spatially and
// gamma_correct_for_srgb_during_spatial_luma_scaling
/*
 static void flow_jpeg_idct_method_selector(j_decompress_ptr cinfo, jpeg_component_info * compptr,
                                           jpeg_idct_method * set_idct_method, int *
set_idct_category)
{
    if (compptr->component_id != 1)
        return;
#if JPEG_LIB_VERSION >= 70
    int scaled = compptr->DCT_h_scaled_size;
#else
    int scaled = compptr->DCT_scaled_size;
#endif

    struct flow_job_jpeg_decoder_state * state = (struct flow_job_jpeg_decoder_state *)cinfo->err;

    if (scaled > 0 && scaled < 8 && state->hints.scale_luma_spatially) {
        if (state->hints.gamma_correct_for_srgb_during_spatial_luma_scaling) {
            switch (scaled) {
                case 1:
                    *set_idct_method = jpeg_idct_spatial_srgb_1x1;
                    break;
                case 2:
                    *set_idct_method = jpeg_idct_spatial_srgb_2x2;
                    break;
                case 3:
                    *set_idct_method = jpeg_idct_spatial_srgb_3x3;
                    break;
                case 4:
                    *set_idct_method = jpeg_idct_spatial_srgb_4x4;
                    break;
                case 5:
                    *set_idct_method = jpeg_idct_spatial_srgb_5x5;
                    break;
                case 6:
                    *set_idct_method = jpeg_idct_spatial_srgb_6x6;
                    break;
                case 7:
                    *set_idct_method = jpeg_idct_spatial_srgb_7x7;
                    break;
            }
        } else {
            switch (scaled) {
                case 1:
                    *set_idct_method = jpeg_idct_spatial_1x1;
                    break;
                case 2:
                    *set_idct_method = jpeg_idct_spatial_2x2;
                    break;
                case 3:
                    *set_idct_method = jpeg_idct_spatial_3x3;
                    break;
                case 4:
                    *set_idct_method = jpeg_idct_spatial_4x4;
                    break;
                case 5:
                    *set_idct_method = jpeg_idct_spatial_5x5;
                    break;
                case 6:
                    *set_idct_method = jpeg_idct_spatial_6x6;
                    break;
                case 7:
                    *set_idct_method = jpeg_idct_spatial_7x7;
                    break;
            }
        }
        *set_idct_category = JDCT_ISLOW;
    }
}
*/

#include <stdio.h>
#include <stdint.h>

#define JPEG_INTERNALS
#include "jpeglib.h"
#include "jdct.h" /* Private declarations for DCT subsystem */

static inline uint8_t uchar_clamp_ff(float clr)
{
    uint16_t result;
    result = (uint16_t)(int16_t)(clr + 0.5);
    if (result > 255) {
        result = (clr < 0) ? 0 : 255;
    }
    return (uint8_t)result;
}

void jpeg_idct_spatial_srgb_1x1(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_srgb_2x2(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_srgb_3x3(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_srgb_4x4(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_srgb_5x5(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_srgb_6x6(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_srgb_7x7(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_1x1(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_2x2(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_3x3(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_4x4(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_5x5(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_6x6(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

void jpeg_idct_spatial_7x7(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col) __attribute__((hot))
__attribute__((optimize("-funsafe-math-optimizations", "-ffinite-math-only", "-fsingle-precision-constant",
                        "-fno-signaling-nans")));

static const float jpeg_scale_to_6_x_6_weights[6][8] = {
    { 0.7491279840469360352, 0.2508720457553863525, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000,
      0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { -0.0224444177001714706, 0.5224443674087524414, 0.5224443674087524414, -0.0224444177001714706,
      0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.2396661937236785889, 0.7156662940979003906, 0.0446674935519695282,
      0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0446674935519695282, 0.7156662940979003906,
      0.2396661937236785889, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000,
      -0.0224444177001714706, 0.5224443674087524414, 0.5224443674087524414, -0.0224444177001714706 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000,
      0.0000000000000000000, 0.2508720457553863525, 0.7491279840469360352 },
};
static const float jpeg_scale_to_5_x_5_weights[5][8] = {
    { 0.6118828058242797852, 0.4002380371093750000, -0.0121208345517516136, 0.0000000000000000000,
      0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { -0.0219573117792606354, 0.2555175423622131348, 0.6176261901855468750, 0.1488135904073715210,
      0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0161152519285678864, 0.4838847517967224121, 0.4838847517967224121,
      0.0161152519285678864, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.1488135904073715210,
      0.6176261901855468750, 0.2555175423622131348, -0.0219573117792606354 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000,
      -0.0121208345517516136, 0.4002380371093750000, 0.6118828058242797852 },
};
static const float jpeg_scale_to_4_x_4_weights[4][8] = {
    { 0.4553350806236267090, 0.4553350806236267090, 0.0893298164010047913, 0.0000000000000000000, 0.0000000000000000000,
      0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0820043832063674927, 0.4179956316947937012, 0.4179956316947937012, 0.0820043832063674927,
      0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0820043832063674927, 0.4179956316947937012,
      0.4179956316947937012, 0.0820043832063674927, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000,
      0.0893298164010047913, 0.4553350806236267090, 0.4553350806236267090 },
};
static const float jpeg_scale_to_3_x_3_weights[3][8] = {
    { 0.3126847147941589355, 0.4027547538280487061, 0.2417637705802917480, 0.0427967458963394165, 0.0000000000000000000,
      0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0095250364392995834, 0.1524054706096649170, 0.3380694985389709473, 0.3380694985389709473,
      0.1524054706096649170, 0.0095250364392995834, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.0427967458963394165,
      0.2417637705802917480, 0.4027547538280487061, 0.3126847147941589355 },
};
static const float jpeg_scale_to_2_x_2_weights[2][8] = {
    { 0.1866819113492965698, 0.2613925635814666748, 0.2613925635814666748, 0.1866819113492965698, 0.0875365510582923889,
      0.0163145177066326141, 0.0000000000000000000, 0.0000000000000000000 },
    { 0.0000000000000000000, 0.0000000000000000000, 0.0163145177066326141, 0.0875365510582923889, 0.1866819113492965698,
      0.2613925635814666748, 0.2613925635814666748, 0.1866819113492965698 },
};
static const float jpeg_scale_to_1_x_1_weights[1][8] = {
    { 0.0911070853471755981, 0.1178331747651100159, 0.1392842531204223633, 0.1517754793167114258, 0.1517754793167114258,
      0.1392842531204223633, 0.1178331747651100159, 0.0911070853471755981 },
};
static const uint8_t lut_linear_to_srgb[3840] = {
    0,   1,   2,   3,   4,   5,   6,   6,   7,   8,   9,   10,  11,  12,  12,  13,  14,  14,  15,  16,  16,  17,  18,
    18,  19,  19,  20,  20,  21,  21,  22,  22,  23,  23,  24,  24,  25,  25,  26,  26,  26,  27,  27,  28,  28,  28,
    29,  29,  30,  30,  30,  31,  31,  31,  32,  32,  32,  33,  33,  33,  34,  34,  34,  35,  35,  35,  36,  36,  36,
    37,  37,  37,  37,  38,  38,  38,  39,  39,  39,  39,  40,  40,  40,  41,  41,  41,  41,  42,  42,  42,  42,  43,
    43,  43,  43,  44,  44,  44,  44,  45,  45,  45,  45,  46,  46,  46,  46,  47,  47,  47,  47,  48,  48,  48,  48,
    48,  49,  49,  49,  49,  50,  50,  50,  50,  50,  51,  51,  51,  51,  52,  52,  52,  52,  52,  53,  53,  53,  53,
    53,  54,  54,  54,  54,  54,  55,  55,  55,  55,  55,  56,  56,  56,  56,  56,  57,  57,  57,  57,  57,  57,  58,
    58,  58,  58,  58,  59,  59,  59,  59,  59,  59,  60,  60,  60,  60,  60,  61,  61,  61,  61,  61,  61,  62,  62,
    62,  62,  62,  62,  63,  63,  63,  63,  63,  63,  64,  64,  64,  64,  64,  64,  65,  65,  65,  65,  65,  65,  66,
    66,  66,  66,  66,  66,  67,  67,  67,  67,  67,  67,  67,  68,  68,  68,  68,  68,  68,  69,  69,  69,  69,  69,
    69,  69,  70,  70,  70,  70,  70,  70,  71,  71,  71,  71,  71,  71,  71,  72,  72,  72,  72,  72,  72,  72,  73,
    73,  73,  73,  73,  73,  73,  74,  74,  74,  74,  74,  74,  74,  75,  75,  75,  75,  75,  75,  75,  75,  76,  76,
    76,  76,  76,  76,  76,  77,  77,  77,  77,  77,  77,  77,  77,  78,  78,  78,  78,  78,  78,  78,  79,  79,  79,
    79,  79,  79,  79,  79,  80,  80,  80,  80,  80,  80,  80,  80,  81,  81,  81,  81,  81,  81,  81,  81,  82,  82,
    82,  82,  82,  82,  82,  82,  83,  83,  83,  83,  83,  83,  83,  83,  84,  84,  84,  84,  84,  84,  84,  84,  84,
    85,  85,  85,  85,  85,  85,  85,  85,  86,  86,  86,  86,  86,  86,  86,  86,  86,  87,  87,  87,  87,  87,  87,
    87,  87,  88,  88,  88,  88,  88,  88,  88,  88,  88,  89,  89,  89,  89,  89,  89,  89,  89,  89,  90,  90,  90,
    90,  90,  90,  90,  90,  90,  91,  91,  91,  91,  91,  91,  91,  91,  91,  92,  92,  92,  92,  92,  92,  92,  92,
    92,  92,  93,  93,  93,  93,  93,  93,  93,  93,  93,  94,  94,  94,  94,  94,  94,  94,  94,  94,  95,  95,  95,
    95,  95,  95,  95,  95,  95,  95,  96,  96,  96,  96,  96,  96,  96,  96,  96,  96,  97,  97,  97,  97,  97,  97,
    97,  97,  97,  97,  98,  98,  98,  98,  98,  98,  98,  98,  98,  98,  99,  99,  99,  99,  99,  99,  99,  99,  99,
    99,  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 101, 101, 101, 101, 101, 101, 101, 101, 101, 101, 101, 102,
    102, 102, 102, 102, 102, 102, 102, 102, 102, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 104, 104, 104,
    104, 104, 104, 104, 104, 104, 104, 104, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 105, 106, 106, 106, 106,
    106, 106, 106, 106, 106, 106, 106, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 108, 108, 108, 108, 108,
    108, 108, 108, 108, 108, 108, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 109, 110, 110, 110, 110, 110,
    110, 110, 110, 110, 110, 110, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 111, 112, 112, 112, 112, 112,
    112, 112, 112, 112, 112, 112, 112, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 113, 114, 114, 114, 114,
    114, 114, 114, 114, 114, 114, 114, 114, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 116, 116, 116,
    116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 118,
    118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 118, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119,
    119, 119, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 120, 121, 121, 121, 121, 121, 121, 121, 121,
    121, 121, 121, 121, 121, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 123, 123, 123, 123, 123,
    123, 123, 123, 123, 123, 123, 123, 123, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 125,
    125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 125, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126, 126,
    126, 126, 126, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 130,
    130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 130, 131, 131, 131, 131, 131, 131, 131, 131, 131, 131,
    131, 131, 131, 131, 131, 132, 132, 132, 132, 132, 132, 132, 132, 132, 132, 132, 132, 132, 132, 133, 133, 133, 133,
    133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134, 134,
    134, 134, 134, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 135, 136, 136, 136, 136, 136,
    136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137, 137,
    137, 137, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 138, 139, 139, 139, 139, 139, 139,
    139, 139, 139, 139, 139, 139, 139, 139, 139, 139, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140, 140,
    140, 140, 140, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 141, 142, 142, 142, 142, 142,
    142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 143, 143, 143, 143, 143, 143, 143, 143, 143, 143, 143, 143,
    143, 143, 143, 143, 143, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 145, 145,
    145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 145, 146, 146, 146, 146, 146, 146, 146, 146, 146,
    146, 146, 146, 146, 146, 146, 146, 146, 147, 147, 147, 147, 147, 147, 147, 147, 147, 147, 147, 147, 147, 147, 147,
    147, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 149, 149, 149, 149, 149,
    149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150,
    150, 150, 150, 150, 150, 150, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151,
    151, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 153, 153, 153, 153, 153,
    153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154,
    154, 154, 154, 154, 154, 154, 154, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155,
    155, 155, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 157, 157, 157,
    157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 158, 158, 158, 158, 158, 158, 158, 158,
    158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159,
    159, 159, 159, 159, 159, 159, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160,
    160, 160, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 162, 162,
    162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 163, 163, 163, 163, 163, 163,
    163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164,
    164, 164, 164, 164, 164, 164, 164, 164, 164, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165, 165,
    165, 165, 165, 165, 165, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166, 166,
    166, 166, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 167, 168, 168,
    168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 169, 169, 169, 169, 169,
    169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 169, 170, 170, 170, 170, 170, 170, 170, 170,
    170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 171,
    171, 171, 171, 171, 171, 171, 171, 171, 171, 171, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172, 172,
    172, 172, 172, 172, 172, 172, 172, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173, 173,
    173, 173, 173, 173, 173, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174, 174,
    174, 174, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175, 175,
    176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 176, 177, 177,
    177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 177, 178, 178, 178, 178,
    178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 179, 179, 179, 179, 179,
    179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 179, 180, 180, 180, 180, 180, 180, 180,
    180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 181, 181, 181, 181, 181, 181, 181, 181,
    181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 181, 182, 182, 182, 182, 182, 182, 182, 182, 182,
    182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 182, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183,
    183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 183, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184,
    184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 184, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185,
    185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 185, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 186,
    186, 186, 186, 186, 186, 186, 186, 186, 186, 186, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 187,
    187, 187, 187, 187, 187, 187, 187, 187, 187, 187, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188,
    188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189,
    189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190,
    190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191,
    191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
    192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193,
    193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194,
    194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195,
    195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 196, 196, 196, 196, 196, 196, 196, 196, 196,
    196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 197, 197, 197, 197, 197, 197, 197, 197,
    197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 198, 198, 198, 198, 198, 198,
    198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 198, 199, 199, 199, 199, 199,
    199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 200, 200, 200,
    200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 200, 201,
    201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201, 201,
    201, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 202,
    202, 202, 202, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203, 203,
    203, 203, 203, 203, 203, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204, 204,
    204, 204, 204, 204, 204, 204, 204, 204, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205,
    205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206,
    206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 206, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207,
    207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 208, 208, 208, 208, 208, 208, 208,
    208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 209, 209, 209,
    209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209, 209,
    210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210,
    210, 210, 210, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211, 211,
    211, 211, 211, 211, 211, 211, 211, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212,
    212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 212, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213,
    213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 213, 214, 214, 214, 214, 214, 214, 214, 214,
    214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 215, 215, 215, 215,
    215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215, 215,
    216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216, 216,
    216, 216, 216, 216, 216, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 217,
    217, 217, 217, 217, 217, 217, 217, 217, 217, 217, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218,
    218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 218, 219, 219, 219, 219, 219, 219, 219, 219, 219,
    219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 219, 220, 220, 220, 220,
    220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220, 220,
    220, 220, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221,
    221, 221, 221, 221, 221, 221, 221, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222,
    222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 222, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223,
    223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 223, 224, 224, 224, 224, 224,
    224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224,
    224, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225,
    225, 225, 225, 225, 225, 225, 225, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226,
    226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 226, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227,
    227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 227, 228, 228, 228,
    228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228, 228,
    228, 228, 228, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 229,
    229, 229, 229, 229, 229, 229, 229, 229, 229, 229, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230,
    230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 230, 231, 231, 231, 231, 231, 231,
    231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231, 231,
    231, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232, 232,
    232, 232, 232, 232, 232, 232, 232, 232, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233,
    233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 234, 234, 234, 234, 234, 234, 234, 234,
    234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234, 234,
    235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235, 235,
    235, 235, 235, 235, 235, 235, 235, 235, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
    236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 236, 237, 237, 237, 237, 237, 237, 237,
    237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237, 237,
    237, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238, 238,
    238, 238, 238, 238, 238, 238, 238, 238, 238, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239,
    239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 239, 240, 240, 240, 240, 240, 240,
    240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 240,
    240, 240, 240, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
    241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 241, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242,
    242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 242, 243, 243,
    243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243, 243,
    243, 243, 243, 243, 243, 243, 243, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244,
    244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 244, 245, 245, 245, 245, 245, 245, 245,
    245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245,
    245, 245, 245, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246,
    246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 246, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247,
    247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 247, 248,
    248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248, 248,
    248, 248, 248, 248, 248, 248, 248, 248, 248, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249,
    249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 249, 250, 250, 250, 250,
    250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250,
    250, 250, 250, 250, 250, 250, 250, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251,
    251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 251, 252, 252, 252, 252, 252, 252,
    252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252,
    252, 252, 252, 252, 252, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253,
    253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 254, 254, 254, 254, 254, 254, 254,
    254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254,
    254, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
};
static const float lut_srgb_to_linear[256] = {
    0.0000000000000000000, 0.0003035269910469651, 0.0006070539820939302, 0.0009105810313485563, 0.0012141079641878605,
    0.0015176349552348256, 0.0018211620626971126, 0.0021246890537440777, 0.0024282159283757210, 0.0027317430358380079,
    0.0030352699104696512, 0.0033465356100350618, 0.0036765069235116243, 0.0040247170254588127, 0.0043914420530200005,
    0.0047769532538950443, 0.0051815165206789970, 0.0056053916923701763, 0.0060488325543701649, 0.0065120910294353962,
    0.0069954101927578449, 0.0074990317225456238, 0.0080231921747326851, 0.0085681248456239700, 0.0091340569779276848,
    0.0097212176769971848, 0.0103298230096697807, 0.0109600936993956566, 0.0116122448816895485, 0.0122864870354533195,
    0.0129830306395888329, 0.0137020805850625038, 0.0144438436254858971, 0.0152085144072771072, 0.0159962922334671021,
    0.0168073736131191254, 0.0176419522613286972, 0.0185002181679010391, 0.0193823613226413727, 0.0202885642647743225,
    0.0212190095335245132, 0.0221738833934068680, 0.0231533646583557129, 0.0241576302796602249, 0.0251868572086095810,
    0.0262412223964929581, 0.0273208916187286377, 0.0284260381013154984, 0.0295568425208330154, 0.0307134501636028290,
    0.0318960398435592651, 0.0331047736108303070, 0.0343398116528987885, 0.0356013253331184387, 0.0368894562125205994,
    0.0382043756544589996, 0.0395462512969970703, 0.0409152098000049591, 0.0423114225268363953, 0.0437350422143936157,
    0.0451862141489982605, 0.0466650947928428650, 0.0481718331575393677, 0.0497065745294094086, 0.0512694641947746277,
    0.0528606548905372620, 0.0544802807271480560, 0.0561284944415092468, 0.0578054338693618774, 0.0595112442970275879,
    0.0612460710108280182, 0.0630100294947624207, 0.0648032799363136292, 0.0666259527206420898, 0.0684781819581985474,
    0.0703601092100143433, 0.0722718611359596252, 0.0742135792970657349, 0.0761853903532028198, 0.0781874284148216248,
    0.0802198275923728943, 0.0822827070951461792, 0.0843762159347534180, 0.0865004658699035645, 0.0886556059122085571,
    0.0908417254686355591, 0.0930589810013771057, 0.0953074842691421509, 0.0975873619318008423, 0.0998987406492233276,
    0.1022417470812797546, 0.1046164929866790771, 0.1070231124758720398, 0.1094617173075675964, 0.1119324341416358948,
    0.1144353821873664856, 0.1169706955552101135, 0.1195384562015533447, 0.1221388131380081177, 0.1247718632221221924,
    0.1274377256631851196, 0.1301365196704864502, 0.1328683644533157349, 0.1356333643198013306, 0.1384316533803939819,
    0.1412633359432220459, 0.1441285014152526855, 0.1470272988080978394, 0.1499598324298858643, 0.1529261767864227295,
    0.1559264957904815674, 0.1589608639478683472, 0.1620294302701950073, 0.1651322543621063232, 0.1682694554328918457,
    0.1714411526918411255, 0.1746474504470825195, 0.1778884530067443848, 0.1811642944812774658, 0.1844750344753265381,
    0.1878208220005035400, 0.1912017166614532471, 0.1946178674697875977, 0.1980693489313125610, 0.2015562951564788818,
    0.2050787657499313354, 0.2086369097232818604, 0.2122307866811752319, 0.2158605158329010010, 0.2195262312889099121,
    0.2232279777526855469, 0.2269658893346786499, 0.2307400703430175781, 0.2345506548881530762, 0.2383976578712463379,
    0.2422811985015869141, 0.2462013959884643555, 0.2501583695411682129, 0.2541521489620208740, 0.2581829130649566650,
    0.2622507214546203613, 0.2663556635379791260, 0.2704978585243225098, 0.2746773660182952881, 0.2788943052291870117,
    0.2831487953662872314, 0.2874408960342407227, 0.2917706966400146484, 0.2961383163928985596, 0.3005438446998596191,
    0.3049873709678649902, 0.3094689846038818359, 0.3139887452125549316, 0.3185468316078186035, 0.3231432437896728516,
    0.3277781605720520020, 0.3324515819549560547, 0.3371636569499969482, 0.3419144451618194580, 0.3467040657997131348,
    0.3515326976776123047, 0.3564002513885498047, 0.3613068759441375732, 0.3662526905536651611, 0.3712377548217773438,
    0.3762622177600860596, 0.3813261091709136963, 0.3864295184612274170, 0.3915725648403167725, 0.3967553079128265381,
    0.4019778668880462646, 0.4072402715682983398, 0.4125427007675170898, 0.4178851246833801270, 0.4232677519321441650,
    0.4286905527114868164, 0.4341537058353424072, 0.4396572411060333252, 0.4452012479305267334, 0.4507858455181121826,
    0.4564110636711120605, 0.4620770514011383057, 0.4677838385105133057, 0.4735315442085266113, 0.4793202280998229980,
    0.4851499795913696289, 0.4910208880901336670, 0.4969330430030822754, 0.5028865933418273926, 0.5088814496994018555,
    0.5149177908897399902, 0.5209956765174865723, 0.5271153450012207031, 0.5332766175270080566, 0.5394797325134277344,
    0.5457246899604797363, 0.5520116090774536133, 0.5583406090736389160, 0.5647116899490356445, 0.5711250305175781250,
    0.5775806307792663574, 0.5840786099433898926, 0.5906190276145935059, 0.5972020030021667480, 0.6038275361061096191,
    0.6104957461357116699, 0.6172067523002624512, 0.6239605545997619629, 0.6307573318481445312, 0.6375970840454101562,
    0.6444798707962036133, 0.6514058113098144531, 0.6583750247955322266, 0.6653874516487121582, 0.6724433302879333496,
    0.6795426011085510254, 0.6866855025291442871, 0.6938720345497131348, 0.7011021375656127930, 0.7083760499954223633,
    0.7156937122344970703, 0.7230553627014160156, 0.7304610013961791992, 0.7379106283187866211, 0.7454044818878173828,
    0.7529424428939819336, 0.7605247497558593750, 0.7681514024734497070, 0.7758224606513977051, 0.7835380434989929199,
    0.7912981510162353516, 0.7991029620170593262, 0.8069524765014648438, 0.8148468136787414551, 0.8227859735488891602,
    0.8307700753211975098, 0.8387992382049560547, 0.8468734622001647949, 0.8549928069114685059, 0.8631573915481567383,
    0.8713673353195190430, 0.8796225786209106445, 0.8879231810569763184, 0.8962695598602294922, 0.9046613574028015137,
    0.9130989909172058105, 0.9215820431709289551, 0.9301111698150634766, 0.9386858940124511719, 0.9473068118095397949,
    0.9559735059738159180, 0.9646865725517272949, 0.9734454154968261719, 0.9822508692741394043, 0.9911022186279296875,
    1.0000000000000000000,
};

#define JPEG_IDCT_SPATIAL_SRGB_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, scaled, summation)          \
    JSAMPLE result[DCTSIZE2];                                                                                          \
    JSAMPROW rows[DCTSIZE]                                                                                             \
        = { &result[0],           &result[DCTSIZE],     &result[DCTSIZE * 2], &result[DCTSIZE * 3],                    \
            &result[DCTSIZE * 4], &result[DCTSIZE * 5], &result[DCTSIZE * 6], &result[DCTSIZE * 7] };                  \
    int i;                                                                                                             \
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);                                                          \
    float linearized[DCTSIZE2];                                                                                        \
    for (i = 0; i < DCTSIZE2; i++)                                                                                     \
        linearized[i] = lut_srgb_to_linear[result[i]];                                                                 \
    float scaled_h[DCTSIZE2];                                                                                          \
    for (int row = 0; row < DCTSIZE; row++) {                                                                          \
        float * r = &linearized[row * DCTSIZE];                                                                        \
        float * dest = &scaled_h[row];                                                                                 \
        summation                                                                                                      \
    }                                                                                                                  \
    for (int row = 0; row < scaled; row++) {                                                                           \
        float * r = &scaled_h[row * DCTSIZE];                                                                          \
        float * dest = &linearized[row];                                                                               \
        summation                                                                                                      \
    }                                                                                                                  \
    for (int row = 0; row < scaled; row++) {                                                                           \
        for (int col = 0; col < scaled; col++) {                                                                       \
            *(output_buf[row] + output_col + col)                                                                      \
                = lut_linear_to_srgb[(size_t)(linearized[row * DCTSIZE + col] * (sizeof(lut_linear_to_srgb) - 1))];    \
        }                                                                                                              \
    }

#define DEFAULT_WEIGHTED_SUM(scaled, matrix)                                                                           \
    for (int to = 0; to < scaled; to++) {                                                                              \
        float sum = 0;                                                                                                 \
        for (int from = 0; from < DCTSIZE; from++) {                                                                   \
            sum += matrix[to][from] * r[from];                                                                         \
        }                                                                                                              \
        dest[to * DCTSIZE] = sum;                                                                                      \
    }

#define JPEG_IDCT_SPATIAL_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, scaled, summation)               \
    JSAMPLE result[DCTSIZE2];                                                                                          \
    JSAMPROW rows[DCTSIZE]                                                                                             \
        = { &result[0],           &result[DCTSIZE],     &result[DCTSIZE * 2], &result[DCTSIZE * 3],                    \
            &result[DCTSIZE * 4], &result[DCTSIZE * 5], &result[DCTSIZE * 6], &result[DCTSIZE * 7] };                  \
    int i;                                                                                                             \
    jpeg_idct_islow(cinfo, compptr, coef_block, &rows[0], 0);                                                          \
    float linearized[DCTSIZE2];                                                                                        \
    for (i = 0; i < DCTSIZE2; i++)                                                                                     \
        linearized[i] = (float)result[i] * (1.0 / 255.f);                                                              \
    float scaled_h[DCTSIZE2];                                                                                          \
    for (int row = 0; row < DCTSIZE; row++) {                                                                          \
        float * r = &linearized[row * DCTSIZE];                                                                        \
        float * dest = &scaled_h[row];                                                                                 \
        summation                                                                                                      \
    }                                                                                                                  \
    for (int row = 0; row < scaled; row++) {                                                                           \
        float * r = &scaled_h[row * DCTSIZE];                                                                          \
        float * dest = &linearized[row];                                                                               \
        summation                                                                                                      \
    }                                                                                                                  \
    for (int row = 0; row < scaled; row++) {                                                                           \
        for (int col = 0; col < scaled; col++) {                                                                       \
            *(output_buf[row] + output_col + col) = uchar_clamp_ff(linearized[row * DCTSIZE + col] * 255.0f);          \
        }                                                                                                              \
    }

void jpeg_idct_spatial_srgb_1x1(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_SRGB_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 1,
                                   DEFAULT_WEIGHTED_SUM(1, jpeg_scale_to_1_x_1_weights));
}

void jpeg_idct_spatial_srgb_2x2(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_SRGB_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 2,
                                   DEFAULT_WEIGHTED_SUM(2, jpeg_scale_to_2_x_2_weights));
}

void jpeg_idct_spatial_srgb_3x3(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_SRGB_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 3,
                                   DEFAULT_WEIGHTED_SUM(3, jpeg_scale_to_3_x_3_weights));
}

void jpeg_idct_spatial_srgb_4x4(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_SRGB_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 4,
                                   DEFAULT_WEIGHTED_SUM(4, jpeg_scale_to_4_x_4_weights));
}

void jpeg_idct_spatial_srgb_5x5(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_SRGB_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 5,
                                   DEFAULT_WEIGHTED_SUM(5, jpeg_scale_to_5_x_5_weights));
}

void jpeg_idct_spatial_srgb_6x6(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_SRGB_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 6,
                                   DEFAULT_WEIGHTED_SUM(6, jpeg_scale_to_6_x_6_weights));
}

void jpeg_idct_spatial_srgb_7x7(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                                JSAMPARRAY output_buf, JDIMENSION output_col)
{

#define WEIGHTED_SUM_7x7                                                                                               \
    dest[0 * DCTSIZE] = r[0] * 0.9039465785026550293 + r[1] * 0.0960534214973449707;                                   \
    dest[1 * DCTSIZE] = r[0] * -0.0159397963434457779 + r[1] * 0.8046712279319763184 + r[2] * 0.2112685889005661011;   \
    dest[2 * DCTSIZE] = r[1] * -0.0307929217815399170 + r[2] * 0.6724552512168884277 + r[3] * 0.3583376407623291016;   \
    dest[3 * DCTSIZE] = r[2] * -0.0303521882742643356 + r[3] * 0.5303522348403930664 + r[4] * 0.5303522348403930664    \
                        + r[5] * -0.0303521882742643356 + 0;                                                           \
    dest[4 * DCTSIZE] = r[4] * 0.3583376407623291016 + r[5] * 0.6724552512168884277 + r[6] * -0.0307929217815399170;   \
    dest[5 * DCTSIZE] = r[5] * 0.2112685889005661011 + r[6] * 0.8046712279319763184 + r[7] * -0.0159397963434457779;   \
    dest[6 * DCTSIZE] = r[6] * 0.0960534214973449707 + r[7] * 0.9039465785026550293;
    JPEG_IDCT_SPATIAL_SRGB_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 7, WEIGHTED_SUM_7x7);
#undef WEIGHTED_SUM_7x7
}

void jpeg_idct_spatial_1x1(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 1,
                              DEFAULT_WEIGHTED_SUM(1, jpeg_scale_to_1_x_1_weights));
}

void jpeg_idct_spatial_2x2(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 2,
                              DEFAULT_WEIGHTED_SUM(2, jpeg_scale_to_2_x_2_weights));
}

void jpeg_idct_spatial_3x3(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 3,
                              DEFAULT_WEIGHTED_SUM(3, jpeg_scale_to_3_x_3_weights));
}

void jpeg_idct_spatial_4x4(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 4,
                              DEFAULT_WEIGHTED_SUM(4, jpeg_scale_to_4_x_4_weights));
}

void jpeg_idct_spatial_5x5(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 5,
                              DEFAULT_WEIGHTED_SUM(5, jpeg_scale_to_5_x_5_weights));
}

void jpeg_idct_spatial_6x6(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{
    JPEG_IDCT_SPATIAL_SRGB_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 6,
                                   DEFAULT_WEIGHTED_SUM(6, jpeg_scale_to_6_x_6_weights));
}

void jpeg_idct_spatial_7x7(j_decompress_ptr cinfo, jpeg_component_info * compptr, JCOEFPTR coef_block,
                           JSAMPARRAY output_buf, JDIMENSION output_col)
{

#define WEIGHTED_SUM_7x7                                                                                               \
    dest[0 * DCTSIZE] = r[0] * 0.9039465785026550293 + r[1] * 0.0960534214973449707;                                   \
    dest[1 * DCTSIZE] = r[0] * -0.0159397963434457779 + r[1] * 0.8046712279319763184 + r[2] * 0.2112685889005661011;   \
    dest[2 * DCTSIZE] = r[1] * -0.0307929217815399170 + r[2] * 0.6724552512168884277 + r[3] * 0.3583376407623291016;   \
    dest[3 * DCTSIZE] = r[2] * -0.0303521882742643356 + r[3] * 0.5303522348403930664 + r[4] * 0.5303522348403930664    \
                        + r[5] * -0.0303521882742643356 + 0;                                                           \
    dest[4 * DCTSIZE] = r[4] * 0.3583376407623291016 + r[5] * 0.6724552512168884277 + r[6] * -0.0307929217815399170;   \
    dest[5 * DCTSIZE] = r[5] * 0.2112685889005661011 + r[6] * 0.8046712279319763184 + r[7] * -0.0159397963434457779;   \
    dest[6 * DCTSIZE] = r[6] * 0.0960534214973449707 + r[7] * 0.9039465785026550293;
    JPEG_IDCT_SPATIAL_GENERIC(cinfo, compptr, coef_block, output_buf, output_col, 7, WEIGHTED_SUM_7x7);
#undef WEIGHTED_SUM_7x7
}
#undef JPEG_IDCT_SPATIAL_GENERIC
#undef JPEG_IDCT_SPATIAL_SRGB_GENERIC
